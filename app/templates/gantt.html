{% extends "_layout.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h2 class="mb-1">Gantt</h2>
    <div class="small-muted">Project: <span class="badge-soft">{{ active_project.name }}</span></div>
  </div>

  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="/tasks">Tasks board</a>
  </div>
</div>

<div class="card p-3">
  <div id="gantt"></div>
</div>

<!-- Frappe Gantt (simple, dependency + drag/resize + progress built-in) -->
<link rel="stylesheet" href="https://unpkg.com/frappe-gantt/dist/frappe-gantt.css">
<script src="https://unpkg.com/frappe-gantt/dist/frappe-gantt.umd.js"></script>

<script>
  // IMPORTANT: use |safe so JSON isn't HTML-escaped (common reason for blank chart)
  const tasks = {{ gantt_tasks_json | safe }};

  // Quick sanity check (if this prints 0 when you expect tasks, youâ€™re feeding empty data)
  console.log("Gantt tasks:", tasks);

  function postUpdate(taskId, patch) {
    return fetch(`/tasks/${taskId}/gantt-update`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(patch)
    })
    .then(r => r.json())
    .then(j => {
      if (!j || j.ok !== true) {
        console.warn("Update failed:", j);
        alert("Could not save Gantt change. See console for details.");
      }
      return j;
    })
    .catch(err => {
      console.error(err);
      alert("Could not save Gantt change. See console for details.");
    });
  }

  // Frappe Gantt wants:
  // id, name, start, end, progress, dependencies (comma-separated ids)
  const gantt = new Gantt("#gantt", tasks, {
    view_mode: "Day",
    date_format: "YYYY-MM-DD",

    on_click: function(task) {
      // open inline editor on Tasks board
      window.location.href = `/tasks?open=${encodeURIComponent(task.id)}`;
    },

    on_date_change: function(task, start, end) {
      // start/end are JS Date objects
      const s = start.toISOString().slice(0,10);
      const e = end.toISOString().slice(0,10);

      // persist
      postUpdate(task.id, { start: s, end: e });
    },

    on_progress_change: function(task, progress) {
      // persist
      postUpdate(task.id, { progress: Math.round(progress) });
    },

    on_view_change: function(mode) {
      // optional hook
    }
  });

  // Optional: if you want a nicer default scale
  // gantt.change_view_mode("Week");
</script>

<style>
  /* Make it scroll nicely if many tasks */
  #gantt {
    overflow-x: auto;
  }
  /* Slightly taller bars */
  .gantt .bar-wrapper .bar {
    height: 22px;
  }
  .gantt .bar-wrapper {
    padding-top: 6px;
    padding-bottom: 6px;
  }
</style>

{% endblock %}
