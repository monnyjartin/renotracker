{% extends "_layout.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h2 class="mb-1">Gantt</h2>
    <div class="small-muted">
      Project: <span class="badge-soft">{{ active_project.name }}</span>
    </div>
  </div>

  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="/tasks">Tasks board</a>
  </div>
</div>

<div class="card p-3">
  <div id="gantt"></div>
</div>

<div id="toast"
     style="position:fixed;bottom:16px;right:16px;display:none;padding:10px 12px;border-radius:10px;background:#111;color:#fff;font-size:13px;z-index:9999;">
</div>

<!-- Frappe Gantt -->
<link rel="stylesheet" href="https://unpkg.com/frappe-gantt/dist/frappe-gantt.css">
<script src="https://unpkg.com/frappe-gantt/dist/frappe-gantt.umd.js"></script>

<style>
  /* show more rows */
  #gantt { height: 70vh; overflow: hidden; }

  /* make progress fill clearly visible */
  .gantt .bar-progress { opacity: 1; }

  /* stronger colours */
  .gantt .bar-progress { fill: #2e7d32 !important; } /* green */
  .gantt .bar { fill: #bdbdbd !important; }          /* base bar */
</style>

<script>
  const tasks = {{ gantt_tasks_json | safe }};

  function toast(msg, ok=true) {
    const el = document.getElementById("toast");
    el.textContent = msg;
    el.style.display = "block";
    el.style.background = ok ? "#111" : "#b00020";
    setTimeout(() => el.style.display = "none", 1800);
  }

  async function saveTask(id, patch) {
    const res = await fetch(`/tasks/${id}/gantt-update`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(patch)
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok || !data.ok) throw new Error(data.error || "save_failed");
    return data;
  }

  const gantt = new Gantt("#gantt", tasks, {
    view_mode: "Day",
    bar_height: 18,
    padding: 14,

    on_date_change: async (task, start, end) => {
      try {
        await saveTask(task.id, {
          start: start.toISOString().slice(0,10),
          end: end.toISOString().slice(0,10),
        });
        toast("Saved");
      } catch(e) {
        toast("Save failed", false);
      }
    },

    on_progress_change: async (task, progress) => {
      try {
        await saveTask(task.id, { progress: Math.round(progress) });
        toast("Saved");
      } catch(e) {
        toast("Save failed", false);
      }
    },

    // Note: some builds of frappe-gantt don’t fire this event.
    // If you don’t see it firing, we’ll implement dependency save using a custom UI instead.
    on_dependency_change: async (task, deps) => {
      const depStr = Array.isArray(deps) ? deps.join(",") : (deps || "");
      try {
        await saveTask(task.id, { depends_on: depStr });
        toast("Saved");
      } catch(e) {
        toast("Save failed", false);
      }
    }
  });
</script>

{% endblock %}
