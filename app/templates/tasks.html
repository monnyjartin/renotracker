{% extends "_layout.html" %}
{% block content %}

<style>


/* --- Kanban layout: fit the page on desktop, stacked on mobile --- */
.kanban-board{
  display:flex;
  gap:16px;
  align-items:flex-start;
  width:100%;
}

.kanban-col{
  flex:1 1 0;          /* each column shares width equally */
  min-width:0;         /* IMPORTANT: prevents overflow from long content */
}

@media (max-width: 768px){
  .kanban-board{
    flex-direction:column;
  }
  .kanban-col{
    width:100%;
  }
}



  /* --- Drag/drop styling --- */
  .dropzone {
    min-height: 80px;
  }
  .dropzone.drag-over {
    outline: 2px dashed rgba(0,0,0,.25);
    outline-offset: 6px;
    border-radius: 12px;
  }
  .task-card.dragging {
    opacity: .55;
  }

  /* --- Status pill colours --- */
  .status-pill {
    display: inline-block;
    padding: 2px 10px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 600;
    line-height: 18px;
  }
  .pill-todo    { background: rgba(13,110,253,.12); color: #0d6efd; }
  .pill-doing   { background: rgba(13,202,240,.14); color: #0dcaf0; }
  .pill-blocked { background: rgba(255,193,7,.18);  color: #b58100; }
  .pill-done    { background: rgba(25,135,84,.16);  color: #198754; }

  /* --- Status move buttons (colour-coded) --- */
  .btn-status {
    border-radius: 10px;
    padding: 6px 10px;
    font-size: 12px;
    font-weight: 600;
    border: 1px solid rgba(0,0,0,.10);
    background: #fff;
  }
  .btn-status.todo    { color: #0d6efd; }
  .btn-status.doing   { color: #0dcaf0; }
  .btn-status.blocked { color: #b58100; }
  .btn-status.done    { color: #198754; }

  .btn-status.todo:hover    { background: rgba(13,110,253,.08); }
  .btn-status.doing:hover   { background: rgba(13,202,240,.10); }
  .btn-status.blocked:hover { background: rgba(255,193,7,.14); }
  .btn-status.done:hover    { background: rgba(25,135,84,.10); }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h2 class="mb-1">Tasks</h2>
    <div class="small-muted">Project: <span class="badge-soft">{{ active_project.name }}</span></div>
    {% if err %}
      <div class="text-danger small mt-1">Error: {{ err }}</div>
    {% endif %}
  </div>
</div>

<div class="card p-3 mb-3">
  <h5 class="mb-2">Add task</h5>
  <form method="post" action="/tasks/create" class="row g-2 align-items-end">
    <div class="col-12 col-lg-4">
      <label class="form-label small-muted mb-1">Title</label>
      <input class="form-control" name="title" placeholder="e.g., Fit vanity unit" required>
    </div>

    <div class="col-12 col-lg-3">
      <label class="form-label small-muted mb-1">Room</label>
      <select class="form-select" name="room_id">
        <option value="">Unassigned</option>
        {% for r in rooms %}
          <option value="{{ r.id }}">{{ r.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-6 col-md-2">
      <label class="form-label small-muted mb-1">Start date</label>
      <input class="form-control" type="date" name="start_date">
    </div>

    <div class="col-6 col-md-2">
      <label class="form-label small-muted mb-1">End date</label>
      <input class="form-control" type="date" name="end_date">
    </div>

    <div class="col-6 col-lg-2">
      <label class="form-label small-muted mb-1">Due date</label>
      <input class="form-control" type="date" name="due_date">
    </div>

    <div class="col-6 col-lg-1">
      <label class="form-label small-muted mb-1">Priority</label>
      <input class="form-control" type="number" name="priority" value="3" min="1" max="5">
    </div>

    <div class="col-12 col-lg-2 d-grid">
      <button class="btn btn-primary" type="submit">Save</button>
    </div>

    <div class="col-12">
      <label class="form-label small-muted mb-1">Description</label>
      <input class="form-control" name="description" placeholder="Optional">
    </div>
  </form>
</div>

{% set order = ["todo","doing","blocked","done"] %}

<div class="kanban-board" id="kanbanBoard">
  {% for col_name in order %}
    {% set col_tasks = cols[col_name] %}
    <div class="kanban-col">
      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="d-flex align-items-center gap-2">
            <div class="fw-semibold text-capitalize">{{ col_name }}</div>
            <span class="status-pill pill-{{ col_name }}">{{ col_name|capitalize }}</span>
          </div>
          <div class="small-muted">{{ col_tasks|length }}</div>
        </div>

        <div class="dropzone d-grid gap-2"
             data-status="{{ col_name }}"
             aria-label="Drop tasks here">
          {% if col_tasks %}
            {% for t in col_tasks %}
              {% set is_open = (request.query_params.get('open') == t.id) %}
              {% set p = t.progress if t.progress is not none else (100 if t.status == "done" else 0) %}

              <div class="border rounded p-2 task-card"
                   id="task-{{ t.id }}"
                   draggable="true"
                   data-task-id="{{ t.id }}"
                   data-current-status="{{ col_name }}">

                <div class="d-flex justify-content-between align-items-start gap-2">
                  <div class="me-2">
                    <div class="fw-semibold">{{ t.title }}</div>
                    <div class="small-muted">
                      {% if t.room_id %}
                        {% for r in rooms %}{% if r.id == t.room_id %}{{ r.name }}{% endif %}{% endfor %}
                      {% else %}
                        —
                      {% endif %}
                      {% if t.due_date %} • Due {{ t.due_date }}{% endif %}
                      • P{{ t.priority }}
                    </div>
                  </div>

                  <div class="d-flex gap-1 flex-shrink-0">
                    <button
                      class="btn btn-sm btn-outline-secondary"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#edit-task-{{ t.id }}"
                      aria-expanded="{{ 'true' if is_open else 'false' }}"
                      aria-controls="edit-task-{{ t.id }}">
                      Edit
                    </button>

                    <form method="post" action="/tasks/{{ t.id }}/delete" style="display:inline;"
                          onsubmit="return confirm('Delete this task? Linked documents will be unlinked, expenses will be unassigned.');">
                      <button class="btn btn-sm btn-outline-danger" type="submit">Del</button>
                    </form>
                  </div>
                </div>

                {% if t.description %}
                  <div class="small mt-2">{{ t.description }}</div>
                {% endif %}

                <!-- Progress bar on card -->
                <div class="mt-2">
                  <div class="d-flex justify-content-between small-muted">
                    <span>Progress</span>
                    <span>{{ p }}%</span>
                  </div>
                  <div class="progress" style="height: 6px;">
                    <div class="progress-bar" role="progressbar"
                         style="width: {{ p }}%;"
                         aria-valuenow="{{ p }}" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                </div>

                <!-- Colour-coded status buttons -->
                <div class="d-flex flex-wrap gap-2 mt-2">
                  <form method="post" action="/tasks/{{ t.id }}/move">
                    <input type="hidden" name="status" value="todo">
                    <button class="btn-status todo" type="submit">To do</button>
                  </form>
                  <form method="post" action="/tasks/{{ t.id }}/move">
                    <input type="hidden" name="status" value="doing">
                    <button class="btn-status doing" type="submit">Doing</button>
                  </form>
                  <form method="post" action="/tasks/{{ t.id }}/move">
                    <input type="hidden" name="status" value="blocked">
                    <button class="btn-status blocked" type="submit">Blocked</button>
                  </form>
                  <form method="post" action="/tasks/{{ t.id }}/move">
                    <input type="hidden" name="status" value="done">
                    <button class="btn-status done" type="submit">Done</button>
                  </form>
                </div>

                <!-- Inline editor -->
                <div id="edit-task-{{ t.id }}" class="collapse mt-3 {% if is_open %}show{% endif %}">
                  <div class="border rounded p-2 bg-light">
                    <form method="post" action="/tasks/{{ t.id }}/update" class="row g-2">
                      <div class="col-12">
                        <label class="form-label small-muted mb-1">Title</label>
                        <input class="form-control form-control-sm" name="title" value="{{ t.title }}" required>
                      </div>

                      <div class="col-12">
                        <label class="form-label small-muted mb-1">Description</label>
                        <input class="form-control form-control-sm" name="description" value="{{ t.description or '' }}">
                      </div>

                      <div class="col-12 col-lg-6">
                        <label class="form-label small-muted mb-1">Room</label>
                        <select class="form-select form-select-sm" name="room_id">
                          <option value="">Unassigned</option>
                          {% for r in rooms %}
                            <option value="{{ r.id }}" {% if t.room_id == r.id %}selected{% endif %}>{{ r.name }}</option>
                          {% endfor %}
                        </select>
                      </div>

                      <div class="col-6">
                        <label class="form-label small-muted mb-1">Start date</label>
                        <input class="form-control form-control-sm" type="date" name="start_date" value="{{ t.start_date or '' }}">
                      </div>

                      <div class="col-6">
                        <label class="form-label small-muted mb-1">End date</label>
                        <input class="form-control form-control-sm" type="date" name="end_date" value="{{ t.end_date or '' }}">
                      </div>

                      <div class="col-6 col-lg-3">
                        <label class="form-label small-muted mb-1">Due date</label>
                        <input class="form-control form-control-sm" type="date" name="due_date" value="{{ t.due_date or '' }}">
                      </div>

                      <div class="col-6 col-lg-3">
                        <label class="form-label small-muted mb-1">Priority</label>
                        <input class="form-control form-control-sm" type="number" name="priority" value="{{ t.priority }}" min="1" max="5">
                      </div>

                      <!-- Slider progress (this is the one you liked) -->
                      <div class="col-12">
                        <label class="form-label small-muted mb-1">
                          Progress: <span id="prog-val-{{ t.id }}">{{ p }}%</span>
                        </label>

                        <input
                          id="prog-range-{{ t.id }}"
                          type="range"
                          class="form-range"
                          min="0"
                          max="100"
                          step="5"
                          name="progress"
                          value="{{ p }}"
                          oninput="
                            document.getElementById('prog-val-{{ t.id }}').innerText = this.value + '%';
                            document.getElementById('prog-num-{{ t.id }}').value = this.value;
                          "
                        >

                        <input
                          id="prog-num-{{ t.id }}"
                          class="form-control form-control-sm mt-2"
                          type="number"
                          min="0"
                          max="100"
                          value="{{ p }}"
                          oninput="
                            const v=Math.max(0, Math.min(100, parseInt(this.value||0)));
                            this.value=v;
                            document.getElementById('prog-val-{{ t.id }}').innerText = v + '%';
                            document.getElementById('prog-range-{{ t.id }}').value = v;
                          "
                        >
                      </div>

                      <div class="col-12 col-lg-6">
                        <label class="form-label small-muted mb-1">Status</label>
                        <select class="form-select form-select-sm" name="status">
                          <option value="todo" {% if t.status=="todo" %}selected{% endif %}>todo</option>
                          <option value="doing" {% if t.status=="doing" %}selected{% endif %}>doing</option>
                          <option value="blocked" {% if t.status=="blocked" %}selected{% endif %}>blocked</option>
                          <option value="done" {% if t.status=="done" %}selected{% endif %}>done</option>
                        </select>
                      </div>

                      <div class="col-12 d-flex gap-2">
                        <button class="btn btn-primary btn-sm" type="submit">Save</button>
                        <button class="btn btn-outline-secondary btn-sm" type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#edit-task-{{ t.id }}">
                          Cancel
                        </button>
                      </div>
                    </form>
                  </div>
                </div>

              </div>
            {% endfor %}
          {% else %}
            <div class="small-muted">No tasks.</div>
          {% endif %}
        </div>
      </div>
    </div>
  {% endfor %}
</div>

<script>
(function () {
  function postMove(taskId, newStatus) {
    const fd = new FormData();
    fd.append("status", newStatus);

    return fetch(`/tasks/${taskId}/move`, {
      method: "POST",
      body: fd,
      credentials: "same-origin"
    }).then(r => {
      if (!r.ok) throw new Error("Move failed");
      return true;
    });
  }

  let draggingEl = null;
  let draggingId = null;

  document.querySelectorAll(".task-card[draggable='true']").forEach(card => {
    card.addEventListener("dragstart", (e) => {
      draggingEl = card;
      draggingId = card.getAttribute("data-task-id");
      card.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
      e.dataTransfer.setData("text/plain", draggingId);
    });

    card.addEventListener("dragend", () => {
      card.classList.remove("dragging");
      draggingEl = null;
      draggingId = null;
      document.querySelectorAll(".dropzone").forEach(z => z.classList.remove("drag-over"));
    });
  });

  document.querySelectorAll(".dropzone").forEach(zone => {
    zone.addEventListener("dragover", (e) => {
      e.preventDefault();
      zone.classList.add("drag-over");
      e.dataTransfer.dropEffect = "move";
    });

    zone.addEventListener("dragleave", () => {
      zone.classList.remove("drag-over");
    });

    zone.addEventListener("drop", async (e) => {
      e.preventDefault();
      zone.classList.remove("drag-over");

      const newStatus = zone.getAttribute("data-status");
      const taskId = e.dataTransfer.getData("text/plain") || draggingId;
      if (!taskId || !newStatus) return;

      // Optimistic UI: move immediately
      const card = document.querySelector(`.task-card[data-task-id="${taskId}"]`);
      if (!card) return;

      const oldZone = card.closest(".dropzone");
      zone.appendChild(card);

      try {
        await postMove(taskId, newStatus);
        card.setAttribute("data-current-status", newStatus);
      } catch (err) {
        // revert on failure
        if (oldZone) oldZone.appendChild(card);
        alert("Could not move task. Please refresh and try again.");
      }
    });
  });
})();
</script>

{% endblock %}
