{% extends "_layout.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h2 class="mb-1">Documents</h2>
    {% if err %}
      <div class="text-danger small mt-1">Error: {{ err }}</div>
    {% endif %}
  </div>
</div>

<div class="card p-3 mb-3">
  <h5 class="mb-2">Upload document</h5>

  {% if not s3_enabled %}
    <div class="alert alert-warning py-2 mb-2">
      S3/MinIO is not enabled. Uploads may fail until storage is configured.
    </div>
  {% endif %}

  <form method="post" action="/documents/upload" enctype="multipart/form-data" class="row g-2 align-items-end">
    <div class="col-12 col-lg-4">
      <label class="form-label small-muted mb-1">File</label>
      <input class="form-control" type="file" name="file" required>
    </div>

    <div class="col-6 col-lg-2">
      <label class="form-label small-muted mb-1">Type</label>
      <select class="form-select" name="doc_type">
        <option value="receipt">receipt</option>
        <option value="photo">photo</option>
        <option value="warranty">warranty</option>
        <option value="paperwork">paperwork</option>
        <option value="recipe">recipe</option>
      </select>
    </div>

    <div class="col-6 col-lg-2">
      <label class="form-label small-muted mb-1">Photo group</label>
      <select class="form-select" name="photo_group">
        <option value="before">before</option>
        <option value="during">during</option>
        <option value="after">after</option>
      </select>
      <div class="form-text">Only used for type “photo”.</div>
    </div>

    <div class="col-12 col-lg-4">
      <label class="form-label small-muted mb-1">Title</label>
      <input class="form-control" name="title" placeholder="Optional">
    </div>

    <div class="col-12 col-lg-4">
      <label class="form-label small-muted mb-1">Room</label>
      <select class="form-select" name="room_id">
        <option value="">Unassigned</option>
        {% for r in rooms %}
          <option value="{{ r.id }}">{{ r.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12 col-lg-4">
      <label class="form-label small-muted mb-1">Tags</label>
      <input class="form-control" name="tags" placeholder="Comma separated e.g. tiles,kitchen,b&q">
    </div>

    <div class="col-12 col-lg-4">
      <label class="form-label small-muted mb-1">Notes</label>
      <input class="form-control" name="notes" placeholder="Optional">
    </div>

    <div class="col-12 col-lg-6">
      <label class="form-label small-muted mb-1">Link to tasks</label>
      <select class="form-select" name="task_ids" multiple size="6">
        {% for t in tasks %}
          <option value="{{ t.id }}">{{ t.title }}</option>
        {% endfor %}
      </select>
      <div class="form-text">Hold Ctrl/Cmd to select multiple.</div>
    </div>

    <div class="col-12 col-lg-6">
      <label class="form-label small-muted mb-1">Link to expenses</label>
      <select class="form-select" name="expense_ids" multiple size="6">
        {% for e in expenses %}
          <option value="{{ e.id }}"
            {% if preselect_expense_id and e.id == preselect_expense_id %}selected{% endif %}>
            {{ e.purchase_date }} • £{{ '%.2f'|format(e.gross_amount) }} • {{ e.description }}
          </option>
        {% endfor %}
      </select>
      <div class="form-text">Hold Ctrl/Cmd to select multiple.</div>
    </div>

    <div class="col-12 col-lg-2 d-grid">
      <button class="btn btn-primary" type="submit">Upload</button>
    </div>
  </form>
</div>

<div class="card p-3">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h5 class="mb-0">All documents</h5>
    <div class="small-muted">{{ docs|length }}</div>
  </div>

  {% if docs %}
    <div class="d-grid gap-2">
      {% for d in docs %}
        {% set selected_task_ids = doc_task_map.get(d.id, []) %}
        {% set selected_exp_ids  = doc_expense_map.get(d.id, []) %}

        <div class="border rounded p-3">
          <div class="d-flex justify-content-between align-items-start gap-2">
            <div class="me-2">
              <div class="fw-semibold">{{ d.title or (d.original_filename or 'Document') }}</div>
              <div class="small-muted">
                <span class="badge-soft text-capitalize">{{ d.doc_type or 'receipt' }}</span>
                {% if d.photo_group %}<span class="badge-soft text-capitalize">{{ d.photo_group }}</span>{% endif %}
                {% if d.size_bytes %} • {{ (d.size_bytes / 1024)|round(1) }} KB{% endif %}
              </div>

              {% if d.tags %}
                <div class="small-muted mt-1">Tags: {{ d.tags }}</div>
              {% endif %}

              {% if d.notes %}
                <div class="small mt-2">{{ d.notes }}</div>
              {% endif %}
            </div>

            <div class="d-flex gap-1 flex-shrink-0">
              <a class="btn btn-sm btn-outline-secondary" href="/documents/{{ d.id }}/preview" target="_blank">Preview</a>
              <a class="btn btn-sm btn-outline-secondary" href="/documents/{{ d.id }}/download">Download</a>

              <button
                class="btn btn-sm btn-outline-primary"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#edit-doc-{{ d.id }}"
                aria-expanded="false"
                aria-controls="edit-doc-{{ d.id }}">
                Edit
              </button>

              <form method="post" action="/documents/{{ d.id }}/delete" style="display:inline;"
                    onsubmit="return confirm('Delete this document?');">
                <button class="btn btn-sm btn-outline-danger" type="submit">Del</button>
              </form>
            </div>
          </div>

          <div class="collapse mt-3" id="edit-doc-{{ d.id }}">
            <div class="border rounded p-3 bg-light">
              <form method="post" action="/documents/{{ d.id }}/update" class="row g-2">
                <div class="col-12 col-lg-3">
                  <label class="form-label small-muted mb-1">Type</label>
                  <select class="form-select form-select-sm" name="doc_type">
                    <option value="receipt"   {% if d.doc_type=='receipt' %}selected{% endif %}>receipt</option>
                    <option value="photo"     {% if d.doc_type=='photo' %}selected{% endif %}>photo</option>
                    <option value="warranty"  {% if d.doc_type=='warranty' %}selected{% endif %}>warranty</option>
                    <option value="paperwork" {% if d.doc_type=='paperwork' %}selected{% endif %}>paperwork</option>
                    <option value="recipe"    {% if d.doc_type=='recipe' %}selected{% endif %}>recipe</option>
                  </select>
                </div>

                <div class="col-12 col-lg-3">
                  <label class="form-label small-muted mb-1">Photo group</label>
                  <select class="form-select form-select-sm" name="photo_group">
                    <option value="before" {% if d.photo_group=='before' %}selected{% endif %}>before</option>
                    <option value="during" {% if d.photo_group=='during' %}selected{% endif %}>during</option>
                    <option value="after"  {% if d.photo_group=='after' %}selected{% endif %}>after</option>
                  </select>
                  <div class="form-text">Only used for type “photo”.</div>
                </div>

                <div class="col-12 col-lg-6">
                  <label class="form-label small-muted mb-1">Title</label>
                  <input class="form-control form-control-sm" name="title" value="{{ d.title or '' }}">
                </div>

                <div class="col-12 col-lg-6">
                  <label class="form-label small-muted mb-1">Room</label>
                  <select class="form-select form-select-sm" name="room_id">
                    <option value="">Unassigned</option>
                    {% for r in rooms %}
                      <option value="{{ r.id }}" {% if d.room_id == r.id %}selected{% endif %}>{{ r.name }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="col-12 col-lg-6">
                  <label class="form-label small-muted mb-1">Tags</label>
                  <input class="form-control form-control-sm" name="tags" value="{{ d.tags or '' }}">
                </div>

                <div class="col-12">
                  <label class="form-label small-muted mb-1">Notes</label>
                  <input class="form-control form-control-sm" name="notes" value="{{ d.notes or '' }}">
                </div>

                <div class="col-12 col-lg-6">
                  <label class="form-label small-muted mb-1">Linked tasks</label>
                  <select class="form-select form-select-sm" name="task_ids" multiple size="7">
                    {% for t in tasks %}
                      <option value="{{ t.id }}" {% if t.id in selected_task_ids %}selected{% endif %}>
                        {{ t.title }}
                      </option>
                    {% endfor %}
                  </select>
                </div>

                <div class="col-12 col-lg-6">
                  <label class="form-label small-muted mb-1">Linked expenses</label>
                  <!-- ✅ IMPORTANT: name="expense_ids" and multiple -->
                  <select class="form-select form-select-sm" name="expense_ids" multiple size="7">
                    {% for e in expenses %}
                      <option value="{{ e.id }}" {% if e.id in selected_exp_ids %}selected{% endif %}>
                        {{ e.purchase_date }} • £{{ '%.2f'|format(e.gross_amount) }} • {{ e.description }}
                      </option>
                    {% endfor %}
                  </select>
                </div>

                <div class="col-12 d-flex gap-2">
                  <button class="btn btn-primary btn-sm" type="submit">Save</button>
                  <button class="btn btn-outline-secondary btn-sm" type="button"
                          data-bs-toggle="collapse"
                          data-bs-target="#edit-doc-{{ d.id }}">
                    Cancel
                  </button>
                </div>
              </form>
            </div>
          </div>

        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="small-muted">No documents yet.</div>
  {% endif %}
</div>

{% endblock %}
