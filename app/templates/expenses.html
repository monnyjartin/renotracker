{% extends "_layout.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h2 class="mb-1">Expenses</h2>
    <div class="small-muted">Project: <span class="badge-soft">{{ active_project.name }}</span></div>
  </div>
</div>

<div class="card p-3 mb-3">
  <h5 class="mb-2">Quick add expense</h5>
  <form method="post" action="/expenses/create" class="row g-2">
    <div class="col-6 col-md-2">
      <label class="form-label small-muted mb-1">Date</label>
      <input class="form-control" type="date" name="purchase_date" value="{{ today }}" required>
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label small-muted mb-1">Amount (£)</label>
      <input class="form-control" name="gross_amount" placeholder="0.00" required>
    </div>
    <div class="col-12 col-md-4">
      <label class="form-label small-muted mb-1">Description</label>
      <input class="form-control" name="description" placeholder="e.g., Wickes paint & rollers" required>
    </div>
    <div class="col-12 col-md-2">
      <label class="form-label small-muted mb-1">Room</label>
      <select class="form-select" name="room_id">
        <option value="">Unassigned</option>
        {% for r in rooms %}
          <option value="{{ r.id }}">{{ r.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 col-md-2">
      <label class="form-label small-muted mb-1">Task</label>
      <select class="form-select" name="task_id">
        <option value="">Unassigned</option>
        {% for t in tasks %}
          <option value="{{ t.id }}">{{ t.title }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-6 col-md-2">
      <label class="form-label small-muted mb-1">VAT %</label>
      <input class="form-control" name="vat_rate" placeholder="20.00">
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label small-muted mb-1">VAT amount</label>
      <input class="form-control" name="vat_amount" placeholder="0.00">
    </div>
    <div class="col-12 col-md-2">
      <label class="form-label small-muted mb-1">Payment</label>
      <input class="form-control" name="payment_method" placeholder="card/cash">
    </div>
    <div class="col-12 col-md-3">
      <label class="form-label small-muted mb-1">Vendor</label>
      <input class="form-control" name="vendor" placeholder="Optional">
    </div>
    <div class="col-12 col-md-3">
      <label class="form-label small-muted mb-1">Notes</label>
      <input class="form-control" name="notes" placeholder="Optional">
    </div>
    <div class="col-12 col-md-2 d-grid">
      <label class="form-label small-muted mb-1">&nbsp;</label>
      <button class="btn btn-primary" type="submit">Save</button>
    </div>
  </form>
</div>

<div class="card p-3 mb-3">
  <h5 class="mb-2">Filters</h5>
  <form method="get" action="/expenses" class="row g-2">
    <div class="col-12 col-md-4">
      <select class="form-select" name="room_id">
        <option value="">All rooms</option>
        {% for r in rooms %}
          <option value="{{ r.id }}" {% if room_id == r.id %}selected{% endif %}>{{ r.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 col-md-6">
      <select class="form-select" name="task_id">
        <option value="">All tasks</option>
        {% for t in tasks %}
          <option value="{{ t.id }}" {% if task_id == t.id %}selected{% endif %}>{{ t.title }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 col-md-2 d-grid">
      <button class="btn btn-outline-primary" type="submit">Apply</button>
    </div>
  </form>
</div>

<div class="card p-3">
  <h5 class="mb-2">Latest (max 200)</h5>
  {% if expenses %}
    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th>Date</th>
            <th>Description</th>
            <th>Room</th>
            <th>Task</th>
            <th>Receipts</th>
            <th class="text-end">Amount</th>
            <th class="text-end"></th>
          </tr>
        </thead>
        <tbody>
          {% for e in expenses %}
            <tr>
              <td>{{ e.purchase_date }}</td>

              <td>
                <div class="fw-semibold">{{ e.description }}</div>
                {% if e.notes %}<div class="small-muted">{{ e.notes }}</div>{% endif %}
                {% if e.vendor %}<div class="small-muted">Vendor: {{ e.vendor }}</div>{% endif %}
              </td>

              <td class="text-muted">
                {% if e.room_id %}
                  {% for r in rooms %}{% if e.room_id|string == r.id|string %}{{ r.name }}{% endif %}{% endfor %}
                {% else %}
                  <span class="small-muted">—</span>
                {% endif %}
              </td>

              <td class="text-muted">
                {% if e.task_id %}
                  {% for t in tasks %}{% if e.task_id|string == t.id|string %}{{ t.title }}{% endif %}{% endfor %}
                {% else %}
                  <span class="small-muted">—</span>
                {% endif %}
              </td>

              <td>
                {% set docs = docs_by_expense.get(e.id, []) %}
                {% if docs and docs|length > 0 %}
                  <div class="small-muted">{{ docs|length }} linked</div>

                  <div class="mt-1 d-flex flex-wrap gap-1">
                    {% for d in docs[:2] %}
                      {# docs are dicts like {"id": "...", "title": "..."} #}
                      <a class="badge text-bg-light text-decoration-none"
                         href="/documents/{{ d['id'] }}/preview" target="_blank"
                         title="{{ d.get('title','Document') }}">
                        Preview
                      </a>
                      <a class="badge text-bg-light text-decoration-none"
                         href="/documents/{{ d['id'] }}/download"
                         title="{{ d.get('title','Document') }}">
                        Download
                      </a>
                    {% endfor %}

                    {% if docs|length > 2 %}
                      <span class="small-muted">+{{ docs|length - 2 }} more</span>
                    {% endif %}
                  </div>
                {% else %}
                  <span class="small-muted">—</span>
                {% endif %}
              </td>

              <td class="text-end fw-bold">£{{ "%.2f"|format(e.gross_amount) }}</td>

              <td class="text-end">
                <a class="btn btn-sm btn-outline-primary" href="/documents?expense_id={{ e.id }}">Upload receipt</a>
                <button class="btn btn-sm btn-outline-secondary" type="button" onclick="toggleEditExp('{{ e.id }}')">Edit</button>
                <form method="post" action="/expenses/{{ e.id }}/delete" style="display:inline;"
                      onsubmit="return confirm('Delete this expense? This will NOT delete documents; it will unlink them.');">
                  <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                </form>
              </td>
            </tr>

            <tr id="edit-exp-{{ e.id }}" style="display:none;">
              <td colspan="7">
                <div class="border rounded p-3 bg-light">
                  <form method="post" action="/expenses/{{ e.id }}/update" class="row g-2">
                    <div class="col-6 col-md-2">
                      <label class="form-label small-muted mb-1">Date</label>
                      <input class="form-control" type="date" name="purchase_date" value="{{ e.purchase_date }}" required>
                    </div>

                    <div class="col-6 col-md-2">
                      <label class="form-label small-muted mb-1">Amount (£)</label>
                      <input class="form-control" name="gross_amount" value="{{ "%.2f"|format(e.gross_amount) }}" required>
                    </div>

                    <div class="col-12 col-md-4">
                      <label class="form-label small-muted mb-1">Description</label>
                      <input class="form-control" name="description" value="{{ e.description }}" required>
                    </div>

                    <div class="col-12 col-md-2">
                      <label class="form-label small-muted mb-1">Room</label>
                      <select class="form-select" name="room_id">
                        <option value="">Unassigned</option>
                        {% for r in rooms %}
                          <option value="{{ r.id }}" {% if e.room_id|string == r.id|string %}selected{% endif %}>{{ r.name }}</option>
                        {% endfor %}
                      </select>
                    </div>

                    <div class="col-12 col-md-2">
                      <label class="form-label small-muted mb-1">Task</label>
                      <select class="form-select" name="task_id">
                        <option value="">Unassigned</option>
                        {% for t in tasks %}
                          <option value="{{ t.id }}" {% if e.task_id|string == t.id|string %}selected{% endif %}>{{ t.title }}</option>
                        {% endfor %}
                      </select>
                    </div>

                    <div class="col-6 col-md-2">
                      <label class="form-label small-muted mb-1">VAT %</label>
                      <input class="form-control" name="vat_rate" value="{{ e.vat_rate or '' }}">
                    </div>

                    <div class="col-6 col-md-2">
                      <label class="form-label small-muted mb-1">VAT amount</label>
                      <input class="form-control" name="vat_amount" value="{{ e.vat_amount or '' }}">
                    </div>

                    <div class="col-12 col-md-2">
                      <label class="form-label small-muted mb-1">Payment</label>
                      <input class="form-control" name="payment_method" value="{{ e.payment_method or '' }}">
                    </div>

                    <div class="col-12 col-md-3">
                      <label class="form-label small-muted mb-1">Vendor</label>
                      <input class="form-control" name="vendor" value="{{ e.vendor or '' }}">
                    </div>

                    <div class="col-12 col-md-5">
                      <label class="form-label small-muted mb-1">Notes</label>
                      <input class="form-control" name="notes" value="{{ e.notes or '' }}">
                    </div>

                    <div class="col-12 d-flex gap-2">
                      <button class="btn btn-primary" type="submit">Save changes</button>
                      <button class="btn btn-outline-secondary" type="button" onclick="toggleEditExp('{{ e.id }}')">Cancel</button>
                      <a class="btn btn-outline-primary" href="/documents?expense_id={{ e.id }}">Upload receipt</a>
                    </div>
                  </form>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="small-muted">No expenses yet.</div>
  {% endif %}
</div>

<script>
  function toggleEditExp(id) {
    const row = document.getElementById('edit-exp-' + id);
    if (!row) return;
    row.style.display = (row.style.display === 'none' || row.style.display === '') ? 'table-row' : 'none';
  }
</script>
{% endblock %}
