{% extends "_layout.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h2 class="mb-1">Expenses</h2>
    <div class="small-muted">Project: <span class="badge-soft">{{ active_project.name }}</span></div>
  </div>
</div>

<div class="card p-3 mb-3">
  <h5 class="mb-2">Quick add expense</h5>
  <form method="post" action="/expenses/create" class="row g-2">
    <div class="col-6 col-md-2">
      <label class="form-label small-muted mb-1">Date</label>
      <input class="form-control" type="date" name="purchase_date" value="{{ today }}" required>
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label small-muted mb-1">Amount (£)</label>
      <input class="form-control" name="gross_amount" placeholder="0.00" required>
    </div>
    <div class="col-12 col-md-4">
      <label class="form-label small-muted mb-1">Description</label>
      <input class="form-control" name="description" placeholder="e.g., Wickes paint & rollers" required>
    </div>
    <div class="col-12 col-md-2">
      <label class="form-label small-muted mb-1">Room</label>
      <select class="form-select" name="room_id">
        <option value="">Unassigned</option>
        {% for r in rooms %}
          <option value="{{ r.id }}">{{ r.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 col-md-2">
      <label class="form-label small-muted mb-1">Task</label>
      <select class="form-select" name="task_id">
        <option value="">Unassigned</option>
        {% for t in tasks %}
          <option value="{{ t.id }}">{{ t.title }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-6 col-md-2">
      <label class="form-label small-muted mb-1">VAT %</label>
      <input class="form-control" name="vat_rate" placeholder="20.00">
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label small-muted mb-1">VAT amount</label>
      <input class="form-control" name="vat_amount" placeholder="0.00">
    </div>
    <div class="col-12 col-md-2">
      <label class="form-label small-muted mb-1">Payment</label>
      <input class="form-control" name="payment_method" placeholder="card/cash">
    </div>
    <div class="col-12 col-md-6">
      <label class="form-label small-muted mb-1">Notes</label>
      <input class="form-control" name="notes" placeholder="Optional">
    </div>
    <div class="col-12 col-md-2 d-grid">
      <label class="form-label small-muted mb-1">&nbsp;</label>
      <button class="btn btn-primary" type="submit">Save</button>
    </div>
  </form>
</div>

<div class="card p-3 mb-3">
  <h5 class="mb-2">Filters</h5>
  <form method="get" action="/expenses" class="row g-2">
    <div class="col-12 col-md-4">
      <select class="form-select" name="room_id">
        <option value="">All rooms</option>
        {% for r in rooms %}
          <option value="{{ r.id }}" {% if room_id == r.id %}selected{% endif %}>{{ r.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 col-md-6">
      <select class="form-select" name="task_id">
        <option value="">All tasks</option>
        {% for t in tasks %}
          <option value="{{ t.id }}" {% if task_id == t.id %}selected{% endif %}>{{ t.title }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 col-md-2 d-grid">
      <button class="btn btn-outline-primary" type="submit">Apply</button>
    </div>
  </form>
</div>

<div class="card p-3">
  <h5 class="mb-2">Latest (max 200)</h5>
  {% if expenses %}
    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th>Date</th>
            <th>Description</th>
            <th>Room</th>
            <th>Task</th>
            <th class="text-end">Amount</th>
          </tr>
        </thead>
        <tbody>
          {% for e in expenses %}
            <tr>
              <td>{{ e.purchase_date }}</td>
              <td>
                <div class="fw-semibold">{{ e.description }}</div>
                {% if e.notes %}<div class="small-muted">{{ e.notes }}</div>{% endif %}
              </td>
              <td>{% if e.room %}{{ e.room.name }}{% else %}<span class="small-muted">—</span>{% endif %}</td>
              <td>{% if e.task %}{{ e.task.title }}{% else %}<span class="small-muted">—</span>{% endif %}</td>
              <td class="text-end fw-bold">£{{ "%.2f"|format(e.gross_amount) }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="small-muted">No expenses yet.</div>
  {% endif %}
</div>

{% endblock %}
